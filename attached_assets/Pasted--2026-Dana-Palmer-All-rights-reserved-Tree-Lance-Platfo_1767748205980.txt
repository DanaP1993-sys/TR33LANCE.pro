/*
  Â© 2026 Dana Palmer. All rights reserved.
  Tree-Lance Platform
*/

import 'dart:convert';
import 'package:http/http.dart' as http;

enum AIPromptType {
  homeowner,
  contractor,
  platform,
}

class AIService {
  final String apiKey;

  AIService({required this.apiKey});

  /// Public method to get AI response based on prompt type
  Future<String> getAIResponse({
    required String userPrompt,
    required AIPromptType type,
    int maxRetries = 3,
  }) async {
    int attempts = 0;
    while (attempts < maxRetries) {
      try {
        final response = await _callOpenAI(userPrompt, type);
        final parsed = _parseResponse(response);
        if (parsed.isNotEmpty) return parsed;
      } catch (e) {
        print('AIService error: $e');
      }
      attempts++;
    }
    return 'Sorry, unable to generate response at this time.';
  }

  /// Internal: Call OpenAI API
  Future<String> _callOpenAI(String prompt, AIPromptType type) async {
    final systemMessage = _getSystemMessage(type);

    final response = await http.post(
      Uri.parse('https://api.openai.com/v1/chat/completions'),
      headers: {
        'Authorization': 'Bearer $apiKey',
        'Content-Type': 'application/json',
      },
      body: jsonEncode({
        'model': 'gpt-4',
        'messages': [
          {'role': 'system', 'content': systemMessage},
          {'role': 'user', 'content': prompt}
        ],
        'max_tokens': 500,
        'temperature': 0.7,
      }),
    );

    if (response.statusCode != 200) {
      throw Exception('OpenAI API returned ${response.statusCode}: ${response.body}');
    }

    return response.body;
  }

  /// Internal: Parse OpenAI response safely
  String _parseResponse(String responseBody) {
    try {
      final data = jsonDecode(responseBody);
      final content = (data['choices'] as List?)
              ?.firstWhere(
                (c) => c['message'] != null && c['message']['content'] != null,
                orElse: () => null,
              )?['message']['content'] ??
          '';
      return content.trim();
    } catch (e) {
      print('Error parsing OpenAI response: $e');
      return '';
    }
  }

  /// Internal: System prompt based on user type
  String _getSystemMessage(AIPromptType type) {
    switch (type) {
      case AIPromptType.homeowner:
        return 'You are a Tree-Lance assistant helping homeowners describe tree service jobs, set expectations, and answer questions clearly.';
      case AIPromptType.contractor:
        return 'You are a Tree-Lance assistant providing contractors with pricing guidance, job optimization tips, route efficiency, and risk alerts.';
      case AIPromptType.platform:
        return 'You are a Tree-Lance platform AI: detect fraud, analyze patterns, and assist with predictive demand and automated support.';
    }
  }
}